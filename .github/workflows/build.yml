name: Build and publish single extension

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  MODULE_PATH: "src:fr:mangariss"      # chemin du module Gradle, adapté à settings.gradle.kts
  APK_DIR_IN_REPO: "Mangariss"         # dossier sur la branche 'repo' où on mettra l'apk
  INDEX_FILE: "index.min.json"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build release APK
        run: ./gradlew :"${{ env.MODULE_PATH }}":assembleRelease --no-daemon
        # Si ton module a un autre path, adapte MODULE_PATH (ex: src:fr:mangariss)

      - name: Find built release APK
        run: |
          echo "Looking for release APKs..."
          find . -type f -name "*-release.apk" > apk_paths.txt
          cat apk_paths.txt

      - name: Prepare repo branch and publish artifacts
        env:
          VERSION: ${{ github.run_number }}
        run: |
          set -e
          APK_PATH=$(head -n1 apk_paths.txt || true)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found, failing."
            exit 1
          fi
          echo "APK found: $APK_PATH"

          # Prepare commit info
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to branch 'repo' (orphan) and clear it
          if git show-ref --quiet refs/heads/repo; then
            git checkout repo
            git rm -rf . || true
          else
            git checkout --orphan repo
            git rm -rf . || true
          fi

          mkdir -p "${{ env.APK_DIR_IN_REPO }}"
          APK_FILENAME="${{ env.APK_DIR_IN_REPO }}/Mangariss-${VERSION}.apk"
          cp "$APK_PATH" "$APK_FILENAME"

          # Create a minimal index.min.json matching format expected by Mihon/Tachiyomi
          cat > "${{ env.INDEX_FILE }}" <<EOF
            [
            {
                "name": "Mangariss",
                "pkgName": "eu.kanade.tachiyomi.extension.fr.mangariss",
                "versionName": "${VERSION}",
                "versionCode": ${VERSION},
                "lang": "fr",
                "nsfw": false,
                "apk": "${APK_FILENAME}"
            }
            ]
            EOF

          git add "${{ env.APK_DIR_IN_REPO }}" "${{ env.INDEX_FILE }}" || true
          git commit -m "Publish Mangariss build ${VERSION}" || true
          git push -u origin repo --force